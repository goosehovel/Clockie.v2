<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AC Hub - HVAC Monitor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #0f1419;
            --bg-tertiary: #151b23;
            --bg-card: #1a2029;
            --border-color: #2d3640;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-orange: #f97316;
            --accent-purple: #a855f7;
            --accent-cyan: #22d3ee;
            --accent-yellow: #eab308;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            text-decoration: none;
            margin-bottom: 2rem;
        }

        .logo-icon {
            font-size: 1.5rem;
        }

        .nav-section {
            margin-bottom: 1.5rem;
        }

        .nav-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            padding-left: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-blue);
            color: white;
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
            min-height: 100vh;
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* Status Indicator */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-badge.online {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .status-badge.offline {
            background: rgba(248, 81, 73, 0.15);
            color: var(--accent-red);
        }

        .status-badge.unknown {
            background: rgba(139, 148, 158, 0.15);
            color: var(--text-secondary);
        }

        .status-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Cards Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.25rem;
        }

        .card-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* AC State Card */
        .ac-state-card {
            grid-column: span 2;
        }

        .ac-state-display {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .state-indicator {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            position: relative;
        }

        .state-indicator.on {
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(34, 211, 238, 0.05));
            border: 3px solid var(--accent-cyan);
            color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(34, 211, 238, 0.3);
        }

        .state-indicator.off {
            background: linear-gradient(135deg, rgba(139, 148, 158, 0.2), rgba(139, 148, 158, 0.05));
            border: 3px solid var(--text-secondary);
            color: var(--text-secondary);
        }

        .state-indicator.unknown {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.2), rgba(234, 179, 8, 0.05));
            border: 3px solid var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .state-details {
            flex: 1;
        }

        .temp-row {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .temp-item {
            text-align: center;
        }

        .temp-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .temp-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .temp-value.rat { color: var(--accent-orange); }
        .temp-value.sat { color: var(--accent-cyan); }
        .temp-value.oat { color: var(--accent-green); }
        .temp-value.delta { color: var(--accent-purple); }

        /* Sections */
        .section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Time Range Selector */
        .time-selector {
            display: flex;
            gap: 0.5rem;
        }

        .time-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .time-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        /* Charts */
        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Settings Panel */
        .settings-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .setting-group {
            margin-bottom: 1rem;
        }

        .setting-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .setting-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .setting-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toggle {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--bg-tertiary);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.active {
            background: var(--accent-blue);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .toggle.active::after {
            transform: translateX(22px);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #4a90e2;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
        }

        /* Budget Card */
        .budget-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .budget-item {
            text-align: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .budget-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .budget-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Runtime Stats */
        .runtime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .runtime-stat {
            text-align: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
        }

        .runtime-value {
            font-size: 1.25rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-blue);
        }

        .runtime-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem 1.5rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .toast.success { border-left: 4px solid var(--accent-green); }
        .toast.error { border-left: 4px solid var(--accent-red); }
        .toast.warning { border-left: 4px solid var(--accent-yellow); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 220px;
            }
            .main-content {
                margin-left: 220px;
            }
            .ac-state-card {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="/" class="logo">
                <span class="logo-icon">❄️</span>
                <div>
                    <div>AC Hub</div>
                    <div style="font-size: 0.7rem; font-weight: 400; color: var(--text-muted);">HVAC Monitor</div>
                </div>
            </a>

            <nav>
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                    <button class="nav-item active" data-section="dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="9"/>
                            <rect x="14" y="3" width="7" height="5"/>
                            <rect x="14" y="12" width="7" height="9"/>
                            <rect x="3" y="16" width="7" height="5"/>
                        </svg>
                        Dashboard
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Analysis</div>
                    <button class="nav-item" data-section="charts">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"/>
                            <path d="M18 17V9"/>
                            <path d="M13 17V5"/>
                            <path d="M8 17v-3"/>
                        </svg>
                        Charts
                    </button>
                    <button class="nav-item" data-section="budget">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"/>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                        Budget & Cost
                    </button>
                    <button class="nav-item" data-section="server-load">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/>
                            <rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
                            <line x1="6" y1="6" x2="6.01" y2="6"/>
                            <line x1="6" y1="18" x2="6.01" y2="18"/>
                        </svg>
                        Server Load
                    </button>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Configuration</div>
                    <button class="nav-item" data-section="settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        Settings
                    </button>
                </div>
            </nav>

            <div class="sidebar-footer">
                <a href="/" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Clock
                </a>
                <a href="/homehub" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                    Home Hub
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="header-actions">
                    <div id="connectionStatus" class="status-badge unknown">
                        <span class="dot"></span>
                        <span>Loading...</span>
                    </div>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                        </svg>
                        Refresh
                    </button>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section class="section" id="section-dashboard">
                <!-- AC State Card -->
                <div class="card ac-state-card">
                    <div class="card-header">
                        <span class="card-title">AC Compressor Status</span>
                        <span id="detectionStatus" style="font-size: 0.75rem; color: var(--text-muted);">Method C Detection</span>
                    </div>
                    <div class="ac-state-display">
                        <div class="state-indicator" id="stateIndicator">
                            <span id="stateText">--</span>
                        </div>
                        <div class="state-details">
                            <div class="temp-row">
                                <div class="temp-item">
                                    <div class="temp-label">Return Air (RAT)</div>
                                    <div class="temp-value rat" id="ratValue">--°F</div>
                                </div>
                                <div class="temp-item">
                                    <div class="temp-label">Supply Air (SAT)</div>
                                    <div class="temp-value sat" id="satValue">--°F</div>
                                </div>
                                <div class="temp-item">
                                    <div class="temp-label">Outdoor (OAT)</div>
                                    <div class="temp-value oat" id="oatValue">--°F</div>
                                </div>
                                <div class="temp-item">
                                    <div class="temp-label">Delta T (ΔT)</div>
                                    <div class="temp-value delta" id="deltaTValue">--°F</div>
                                </div>
                                <div class="temp-item">
                                    <div class="temp-label">EMA ΔT</div>
                                    <div class="temp-value delta" id="emaDeltaTValue">--°F</div>
                                </div>
                                <div class="temp-item" id="windowStatusItem" style="display: none;">
                                    <div class="temp-label">Window</div>
                                    <div class="temp-value" id="windowStatusValue" style="font-size: 1rem;">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Time Range Selector -->
                <div class="section-header" style="margin-top: 2rem;">
                    <h2 class="section-title">Runtime Summary</h2>
                    <div class="time-selector">
                        <button class="time-btn" data-hours="1">1h</button>
                        <button class="time-btn" data-hours="6">6h</button>
                        <button class="time-btn" data-hours="12">12h</button>
                        <button class="time-btn active" data-hours="24">24h</button>
                        <button class="time-btn" data-hours="168">7d</button>
                        <button class="time-btn" data-hours="720">30d</button>
                    </div>
                </div>

                <!-- Runtime Stats -->
                <div class="card">
                    <div class="runtime-grid" id="runtimeGrid">
                        <div class="runtime-stat">
                            <div class="runtime-value" id="runtimeOn">--</div>
                            <div class="runtime-label">Runtime (ON)</div>
                        </div>
                        <div class="runtime-stat">
                            <div class="runtime-value" id="cycleCount">--</div>
                            <div class="runtime-label">Cycles</div>
                        </div>
                        <div class="runtime-stat">
                            <div class="runtime-value" id="avgCycleLength">--</div>
                            <div class="runtime-label">Avg Cycle</div>
                        </div>
                        <div class="runtime-stat">
                            <div class="runtime-value" id="runtimePercent">--</div>
                            <div class="runtime-label">Runtime %</div>
                        </div>
                        <div class="runtime-stat">
                            <div class="runtime-value" id="deltaTMean">--</div>
                            <div class="runtime-label">Avg ΔT</div>
                        </div>
                        <div class="runtime-stat">
                            <div class="runtime-value" id="deltaTMax">--</div>
                            <div class="runtime-label">Max ΔT</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Budget Summary -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <span class="card-title">Estimated Cost</span>
                        <a href="#" onclick="navigateTo('budget'); return false;" style="font-size: 0.8rem; color: var(--accent-blue);">View Details →</a>
                    </div>
                    <div class="budget-grid">
                        <div class="budget-item">
                            <div class="budget-value" id="estKwh" style="color: var(--accent-cyan);">--</div>
                            <div class="budget-label">Est. kWh</div>
                        </div>
                        <div class="budget-item">
                            <div class="budget-value" id="estCost" style="color: var(--accent-green);">$--</div>
                            <div class="budget-label">Est. Cost</div>
                        </div>
                        <div class="budget-item">
                            <div class="budget-value" id="runtimeHours" style="color: var(--accent-orange);">--</div>
                            <div class="budget-label">Runtime Hours</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Charts Section -->
            <section class="section" id="section-charts" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Temperature & State Charts</h2>
                    <div class="time-selector" id="chartTimeSelector">
                        <button class="time-btn" data-hours="1">1h</button>
                        <button class="time-btn" data-hours="6">6h</button>
                        <button class="time-btn active" data-hours="24">24h</button>
                        <button class="time-btn" data-hours="168">7d</button>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">Temperature (RAT, SAT)</h3>
                    <div class="chart-container">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">Delta T (ΔT) & EMA</h3>
                    <div class="chart-container">
                        <canvas id="deltaTChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">AC State Timeline</h3>
                    <div class="chart-container" style="height: 150px;">
                        <canvas id="stateChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Budget Section -->
            <section class="section" id="section-budget" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Budget & Cost Estimation</h2>
                </div>

                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Total Usage</span>
                        </div>
                        <div class="budget-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="budget-item">
                                <div class="budget-value" id="budgetKwh" style="color: var(--accent-cyan); font-size: 2rem;">--</div>
                                <div class="budget-label">Estimated kWh</div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-value" id="budgetCost" style="color: var(--accent-green); font-size: 2rem;">$--</div>
                                <div class="budget-label">Estimated Cost</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Peak vs Off-Peak Breakdown</span>
                            <div class="toggle-container">
                                <span style="font-size: 0.75rem; color: var(--text-muted); margin-right: 0.5rem;">Peak Pricing</span>
                                <div class="toggle" id="peakPricingToggle" onclick="togglePeakPricing()"></div>
                            </div>
                        </div>
                        <div class="budget-grid" style="grid-template-columns: repeat(3, 1fr);">
                            <div class="budget-item" style="border-left: 3px solid var(--accent-red);">
                                <div class="budget-value" id="peakKwh" style="color: var(--accent-red); font-size: 1.5rem;">--</div>
                                <div class="budget-label">Peak kWh</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);" id="peakCost">$--</div>
                            </div>
                            <div class="budget-item" style="border-left: 3px solid var(--accent-blue);">
                                <div class="budget-value" id="offpeakKwh" style="color: var(--accent-blue); font-size: 1.5rem;">--</div>
                                <div class="budget-label">Off-Peak kWh</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);" id="offpeakCost">$--</div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-value" id="peakHoursDisplay" style="color: var(--text-secondary); font-size: 1rem;">--</div>
                                <div class="budget-label">Peak Hours</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-panel" style="margin-top: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">Cost Parameters</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">
                        ⚠️ These are estimates based on your inputs. Actual costs depend on your AC unit and electric rate.
                    </p>
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label class="setting-label">AC Power Draw (kW)</label>
                            <input type="number" class="setting-input" id="acKwInput" step="0.1" min="0">
                            <div class="setting-hint">Average kW when compressor is running</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Normal Rate ($/kWh)</label>
                            <input type="number" class="setting-input" id="rateInput" step="0.01" min="0">
                            <div class="setting-hint">Off-peak / normal rate</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Peak Rate ($/kWh)</label>
                            <input type="number" class="setting-input" id="peakRateInput" step="0.01" min="0">
                            <div class="setting-hint">Peak hours rate (when enabled)</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Peak Start Hour</label>
                            <select class="setting-input" id="peakStartInput">
                                <option value="0">12 AM</option>
                                <option value="1">1 AM</option>
                                <option value="2">2 AM</option>
                                <option value="3">3 AM</option>
                                <option value="4">4 AM</option>
                                <option value="5">5 AM</option>
                                <option value="6">6 AM</option>
                                <option value="7">7 AM</option>
                                <option value="8">8 AM</option>
                                <option value="9">9 AM</option>
                                <option value="10">10 AM</option>
                                <option value="11">11 AM</option>
                                <option value="12">12 PM</option>
                                <option value="13">1 PM</option>
                                <option value="14">2 PM</option>
                                <option value="15">3 PM</option>
                                <option value="16">4 PM</option>
                                <option value="17">5 PM</option>
                                <option value="18">6 PM</option>
                                <option value="19">7 PM</option>
                                <option value="20">8 PM</option>
                                <option value="21">9 PM</option>
                                <option value="22">10 PM</option>
                                <option value="23">11 PM</option>
                            </select>
                            <div class="setting-hint">When peak pricing starts</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Peak End Hour</label>
                            <select class="setting-input" id="peakEndInput">
                                <option value="0">12 AM</option>
                                <option value="1">1 AM</option>
                                <option value="2">2 AM</option>
                                <option value="3">3 AM</option>
                                <option value="4">4 AM</option>
                                <option value="5">5 AM</option>
                                <option value="6">6 AM</option>
                                <option value="7">7 AM</option>
                                <option value="8">8 AM</option>
                                <option value="9">9 AM</option>
                                <option value="10">10 AM</option>
                                <option value="11">11 AM</option>
                                <option value="12">12 PM</option>
                                <option value="13">1 PM</option>
                                <option value="14">2 PM</option>
                                <option value="15">3 PM</option>
                                <option value="16">4 PM</option>
                                <option value="17">5 PM</option>
                                <option value="18">6 PM</option>
                                <option value="19">7 PM</option>
                                <option value="20">8 PM</option>
                                <option value="21">9 PM</option>
                                <option value="22">10 PM</option>
                                <option value="23">11 PM</option>
                            </select>
                            <div class="setting-hint">When peak pricing ends</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">CDD Base Temp (°F)</label>
                            <input type="number" class="setting-input" id="tbaseInput" step="1" min="0">
                            <div class="setting-hint">For cooling degree day normalization</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 1rem;" onclick="saveBudgetSettings()">Save Settings</button>
                </div>
            </section>

            <!-- Server Load Section -->
            <section class="section" id="section-server-load" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Server Load → Cooling Cost</h2>
                    <div class="time-selector" id="serverTimeSelector">
                        <button class="time-btn" data-hours="1">1h</button>
                        <button class="time-btn" data-hours="6">6h</button>
                        <button class="time-btn active" data-hours="24">24h</button>
                        <button class="time-btn" data-hours="168">7d</button>
                    </div>
                </div>

                <!-- Live Server Metrics -->
                <div class="dashboard-grid" style="margin-bottom: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Live Server Power</span>
                            <span id="serverDataAge" style="font-size: 0.7rem; color: var(--text-muted);">--</span>
                        </div>
                        <div class="budget-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="budget-item">
                                <div class="budget-value" id="serverWattsNow" style="color: var(--accent-orange); font-size: 2rem;">--</div>
                                <div class="budget-label">Watts</div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-value" id="serverBtuNow" style="color: var(--accent-red); font-size: 1.5rem;">--</div>
                                <div class="budget-label">BTU/hr Heat</div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-value" id="serverHeatKwNow" style="color: var(--accent-purple); font-size: 1.5rem;">--</div>
                                <div class="budget-label">kW Heat</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Estimated Cooling Cost Rate</span>
                            <div id="efficiencyStatus" style="font-size: 0.7rem; color: var(--text-muted);">--</div>
                        </div>
                        <div class="budget-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="budget-item">
                                <div class="budget-value" id="serverCostRateNow" style="color: var(--accent-green); font-size: 2rem;">--</div>
                                <div class="budget-label">$/hr (Thermo Equiv)</div>
                                <div style="font-size: 0.65rem; color: var(--text-muted);">If AC ran continuously</div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-value" id="serverCostRateActive" style="color: var(--accent-cyan); font-size: 2rem;">--</div>
                                <div class="budget-label">$/hr (SAT-Gated)</div>
                                <div id="acStateIndicator" style="font-size: 0.65rem; color: var(--text-muted);">SAT: --</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Server Cooling Cost Summary -->
                <div class="dashboard-grid" style="margin-bottom: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Thermodynamic Equivalent Cost</span>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">Upper bound: if AC removed all server heat</div>
                        </div>
                        <div class="budget-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="budget-item">
                                <div class="budget-value" id="thermoCostTotal" style="color: var(--accent-green); font-size: 1.5rem;">$--</div>
                                <div class="budget-label">Total</div>
                            </div>
                            <div class="budget-item" style="border-left: 3px solid var(--accent-blue);">
                                <div class="budget-value" id="thermoCostClosed" style="color: var(--accent-blue); font-size: 1.2rem;">$--</div>
                                <div class="budget-label">Windows Closed</div>
                            </div>
                            <div class="budget-item" style="border-left: 3px solid var(--accent-yellow);">
                                <div class="budget-value" id="thermoCostOpen" style="color: var(--accent-yellow); font-size: 1.2rem;">$--</div>
                                <div class="budget-label">Windows Open</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">SAT-Gated Cost</span>
                            <div style="font-size: 0.65rem; color: var(--text-muted);">Cost when SAT ≤ 65°F (AC running)</div>
                        </div>
                        <div class="budget-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="budget-item">
                                <div class="budget-value" id="acActiveCostTotal" style="color: var(--accent-cyan); font-size: 1.5rem;">$--</div>
                                <div class="budget-label">Total</div>
                            </div>
                            <div class="budget-item" style="border-left: 3px solid var(--accent-blue);">
                                <div class="budget-value" id="acActiveCostClosed" style="color: var(--accent-blue); font-size: 1.2rem;">$--</div>
                                <div class="budget-label">Windows Closed</div>
                            </div>
                            <div class="budget-item" style="border-left: 3px solid var(--accent-yellow);">
                                <div class="budget-value" id="acActiveCostOpen" style="color: var(--accent-yellow); font-size: 1.2rem;">$--</div>
                                <div class="budget-label">Windows Open</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Server Power Stats -->
                <div class="dashboard-grid" style="margin-bottom: 1.5rem;">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Server Power Usage</span>
                        </div>
                        <div class="budget-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="budget-item">
                                <div class="budget-value" id="serverAvgWatts" style="color: var(--accent-orange); font-size: 1.5rem;">--</div>
                                <div class="budget-label">Avg Watts</div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-value" id="serverTotalKwh" style="color: var(--accent-purple); font-size: 1.5rem;">--</div>
                                <div class="budget-label">Total kWh</div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-value" id="serverSamples" style="color: var(--text-secondary); font-size: 1.5rem;">--</div>
                                <div class="budget-label">Data Points</div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Server Watts Input -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Submit Server Watts Reading</span>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label class="setting-label">Current Server Watts</label>
                                <input type="number" class="setting-input" id="manualServerWatts" placeholder="e.g., 450" step="1" min="0">
                            </div>
                            <button class="btn btn-primary" onclick="submitServerWatts()">Submit</button>
                        </div>
                        <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem;">
                            Note: For automatic logging, integrate your server monitoring system with the API endpoint.
                        </div>
                    </div>
                </div>

                <!-- Server Charts -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <span class="card-title">Server Power & Cost Rate</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="height: 250px;">
                            <canvas id="serverWattsChart"></canvas>
                        </div>
                        <div style="height: 250px;">
                            <canvas id="serverCostChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Efficiency Settings Panel -->
                <div class="settings-panel">
                    <h3 style="margin-bottom: 1rem;">AC Efficiency Model</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">
                        Configure how server heat translates to AC electrical consumption. Choose ONE efficiency model.
                    </p>
                    
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label class="setting-label">Efficiency Mode</label>
                            <select class="setting-input" id="efficiencyModeInput">
                                <option value="">-- Select Mode --</option>
                                <option value="COP">COP (Coefficient of Performance)</option>
                                <option value="EER">EER (Energy Efficiency Ratio)</option>
                                <option value="MULTIPLIER">Fixed Multiplier (kW/kW)</option>
                            </select>
                            <div class="setting-hint">How to convert heat load to electrical kW</div>
                        </div>
                        
                        <div class="setting-group" id="copGroup" style="display: none;">
                            <label class="setting-label">COP Value</label>
                            <input type="number" class="setting-input" id="copValueInput" placeholder="e.g., 3.5" step="0.1" min="0.5" max="10">
                            <div class="setting-hint">Typical: 2.5-5.0 (higher = more efficient)</div>
                        </div>
                        
                        <div class="setting-group" id="eerGroup" style="display: none;">
                            <label class="setting-label">EER Value (BTU/W-hr)</label>
                            <input type="number" class="setting-input" id="eerValueInput" placeholder="e.g., 12" step="0.5" min="5" max="30">
                            <div class="setting-hint">Typical: 10-15 (higher = more efficient)</div>
                        </div>
                        
                        <div class="setting-group" id="multiplierGroup" style="display: none;">
                            <label class="setting-label">kW per kW Heat</label>
                            <input type="number" class="setting-input" id="kwPerKwHeatInput" placeholder="e.g., 0.3" step="0.01" min="0.1" max="2">
                            <div class="setting-hint">≈ 1/COP. E.g., 0.3 = 30% of heat as electrical</div>
                        </div>
                    </div>

                    <h4 style="margin: 1.5rem 0 0.75rem 0; color: var(--text-secondary);">Sensor Configuration</h4>
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label class="setting-label">Server Watts Sensor</label>
                            <select class="setting-input" id="serverWattsSensorInput">
                                <option value="">-- Not Installed Yet --</option>
                            </select>
                            <div class="setting-hint">Zigbee power sensor for server load (coming soon)</div>
                        </div>
                        
                        <div class="setting-group">
                            <label class="setting-label">Window Open Sensor</label>
                            <select class="setting-input" id="serverWindowSensorInput">
                                <option value="">-- Select Sensor --</option>
                            </select>
                            <div class="setting-hint">Contact sensor for window open/closed</div>
                        </div>
                        
                        <div class="setting-group">
                            <label class="setting-label">SAT Gating Threshold (°F)</label>
                            <input type="number" class="setting-input" id="satGatingThresholdInput" value="65" step="1" min="40" max="80">
                            <div class="setting-hint">AC is running when SAT ≤ this (default: 65°F)</div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 0.75rem 0; color: var(--text-secondary);">Cost Display Options</h4>
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label class="setting-label">Gating Mode</label>
                            <select class="setting-input" id="serverGatingModeInput">
                                <option value="BOTH">Show Both (Thermo & SAT-Gated)</option>
                                <option value="THERMO_EQUIV">Thermodynamic Equivalent Only</option>
                                <option value="SAT_GATED">SAT-Gated Only (when AC running)</option>
                            </select>
                            <div class="setting-hint">How to report server cooling costs</div>
                        </div>
                        
                        <div class="setting-group">
                            <label class="setting-label">Exclude Windows Open</label>
                            <div class="toggle-container" style="margin-top: 0.5rem;">
                                <div class="toggle" id="serverExcludeWindowsToggle" onclick="toggleServerExcludeWindows()"></div>
                                <span style="margin-left: 0.5rem; font-size: 0.85rem;">Exclude from effective cost</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" style="margin-top: 1rem;" onclick="saveServerSettings()">Save Efficiency Settings</button>
                </div>
            </section>

            <!-- Settings Section -->
            <section class="section" id="section-settings" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Detection Settings</h2>
                </div>

                <div class="settings-panel">
                    <h3 style="margin-bottom: 1rem;">Sensor Mapping</h3>
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label class="setting-label">Return Air Temp (RAT) Sensor</label>
                            <select class="setting-input" id="ratSensorInput">
                                <option value="">-- Select Sensor --</option>
                            </select>
                            <div class="setting-hint">Select your return air duct sensor</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Supply Air Temp (SAT) Sensor</label>
                            <select class="setting-input" id="satSensorInput">
                                <option value="">-- Select Sensor --</option>
                            </select>
                            <div class="setting-hint">Select your supply air duct sensor</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Outdoor Air Temp (OAT)</label>
                            <input type="text" class="setting-input" id="oatSensorInput" value="Weather API" disabled style="opacity: 0.6;">
                            <div class="setting-hint">✓ Automatically pulled from Weather API</div>
                        </div>
                    </div>
                </div>

                <div class="settings-panel" style="margin-top: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">Method C Thresholds</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">
                        These thresholds control when the compressor is detected as ON or OFF based on the temperature difference (ΔT = RAT - SAT).
                    </p>
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label class="setting-label">ΔT ON Threshold (°F)</label>
                            <input type="number" class="setting-input" id="dtOnInput" step="0.5">
                            <div class="setting-hint">Compressor ON when ΔT ≥ this value</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">ΔT OFF Threshold (°F)</label>
                            <input type="number" class="setting-input" id="dtOffInput" step="0.5">
                            <div class="setting-hint">Compressor OFF when ΔT ≤ this value</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Start Confirm Time (sec)</label>
                            <input type="number" class="setting-input" id="startConfirmInput" step="10">
                            <div class="setting-hint">ΔT must stay above threshold this long</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Stop Confirm Time (sec)</label>
                            <input type="number" class="setting-input" id="stopConfirmInput" step="10">
                            <div class="setting-hint">ΔT must stay below threshold this long</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Min ON Duration (sec)</label>
                            <input type="number" class="setting-input" id="minOnInput" step="10">
                            <div class="setting-hint">Ignore runs shorter than this</div>
                        </div>
                    </div>
                </div>

                <div class="settings-panel" style="margin-top: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">SAT-Based Detection (Additional)</h3>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">
                        Uses Supply Air Temperature to detect AC state. Works alongside ΔT detection.
                    </p>
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label class="setting-label">Enable SAT Detection</label>
                            <div class="toggle-container" style="margin-top: 0.5rem;">
                                <div class="toggle active" id="satDetectionToggle" onclick="toggleSetting('satDetection')"></div>
                                <span style="font-size: 0.875rem;">Use SAT stability for ON/OFF detection</span>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">SAT Low Threshold (°F)</label>
                            <input type="number" class="setting-input" id="satLowThresholdInput" step="1" value="65">
                            <div class="setting-hint">SAT below this suggests AC is cooling</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">SAT Stable Confirm (sec)</label>
                            <input type="number" class="setting-input" id="satStableConfirmInput" step="10" value="120">
                            <div class="setting-hint">SAT must stay low/stable this long to trigger ON</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">SAT Rise Delta (°F)</label>
                            <input type="number" class="setting-input" id="satRiseDeltaInput" step="0.5" value="3">
                            <div class="setting-hint">SAT rise from baseline to trigger OFF</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">SAT Stability Tolerance (°F)</label>
                            <input type="number" class="setting-input" id="satStabilityToleranceInput" step="0.5" value="1">
                            <div class="setting-hint">Max variance for "stable" SAT</div>
                            <div class="setting-hint">Ignore ON runs shorter than this</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Min OFF Gap (sec)</label>
                            <input type="number" class="setting-input" id="minOffInput" step="10">
                            <div class="setting-hint">Merge runs with gaps shorter than this</div>
                        </div>
                    </div>
                </div>

                <div class="settings-panel" style="margin-top: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">Smoothing & Gating</h3>
                    <div class="settings-grid">
                        <div class="setting-group">
                            <label class="setting-label">Enable EMA Smoothing</label>
                            <div class="toggle-container" style="margin-top: 0.5rem;">
                                <div class="toggle" id="smoothingToggle" onclick="toggleSetting('smoothing')"></div>
                                <span style="font-size: 0.875rem;">Smooth ΔT with exponential moving average</span>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Smoothing Time Constant (sec)</label>
                            <input type="number" class="setting-input" id="smoothingTauInput" step="30">
                            <div class="setting-hint">Higher = more smoothing</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Enable OAT Gating</label>
                            <div class="toggle-container" style="margin-top: 0.5rem;">
                                <div class="toggle" id="oatGatingToggle" onclick="toggleSetting('oatGating')"></div>
                                <span style="font-size: 0.875rem;">Disable detection when OAT is low</span>
                            </div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">OAT Minimum for Cooling (°F)</label>
                            <input type="number" class="setting-input" id="oatCoolMinInput" step="1">
                            <div class="setting-hint">Disable detection below this OAT</div>
                        </div>
                        <div class="setting-group">
                            <label class="setting-label">Window Open Sensor</label>
                            <select class="setting-input" id="windowSensorInput">
                                <option value="">-- No Sensor --</option>
                            </select>
                            <div class="setting-hint">Contact sensor to detect when windows are open</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" style="margin-top: 1.5rem;" onclick="saveSettings()">Save All Settings</button>
            </section>
        </main>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ============================================================================
        // State
        // ============================================================================
        let state = {
            config: {},
            selectedHours: 24,
            chartHours: 24
        };

        let tempChart = null;
        let deltaTChart = null;
        let stateChart = null;
        let serverWattsChart = null;
        let serverCostChart = null;
        let serverSelectedHours = 24;

        // ============================================================================
        // API Functions
        // ============================================================================
        async function fetchAPI(endpoint, options = {}) {
            try {
                const response = await fetch(`/api/achub${endpoint}`, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                });
                return await response.json();
            } catch (e) {
                console.error('API Error:', e);
                showToast('Failed to fetch data', 'error');
                return null;
            }
        }

        // ============================================================================
        // Navigation
        // ============================================================================
        document.querySelectorAll('.nav-item[data-section]').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                navigateTo(section);
            });
        });

        function navigateTo(section) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`[data-section="${section}"]`)?.classList.add('active');

            // Update sections
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(`section-${section}`).style.display = 'block';

            // Update title
            const titles = {
                dashboard: 'Dashboard',
                charts: 'Charts',
                budget: 'Budget & Cost',
                settings: 'Settings',
                'server-load': 'Server Load'
            };
            document.getElementById('pageTitle').textContent = titles[section] || section;

            // Load section-specific data
            if (section === 'charts') {
                loadChartData();
            } else if (section === 'settings') {
                loadSettings();
            } else if (section === 'budget') {
                loadBudgetData();
            } else if (section === 'server-load') {
                loadServerStatus();
                loadServerSummary();
                loadServerCharts();
                loadServerSettings();
            }
        }

        // ============================================================================
        // Data Loading
        // ============================================================================
        async function refreshData() {
            await Promise.all([
                loadStatus(),
                loadRuntime(),
                loadBudgetSummary()
            ]);
        }

        async function loadStatus() {
            const data = await fetchAPI('/status');
            if (!data) return;

            // Update state indicator
            const indicator = document.getElementById('stateIndicator');
            const stateText = document.getElementById('stateText');
            indicator.className = 'state-indicator ' + (data.state || 'unknown').toLowerCase();
            stateText.textContent = data.state || '--';

            // Update connection status
            const statusBadge = document.getElementById('connectionStatus');
            if (data.state === 'ON') {
                statusBadge.className = 'status-badge online';
                statusBadge.innerHTML = '<span class="dot"></span><span>Cooling Active</span>';
            } else if (data.state === 'OFF') {
                statusBadge.className = 'status-badge offline';
                statusBadge.innerHTML = '<span class="dot"></span><span>Standby</span>';
            } else {
                statusBadge.className = 'status-badge unknown';
                statusBadge.innerHTML = '<span class="dot"></span><span>Unknown</span>';
            }

            // Update temperatures
            document.getElementById('ratValue').textContent = data.rat ? `${data.rat.toFixed(1)}°F` : '--°F';
            document.getElementById('satValue').textContent = data.sat ? `${data.sat.toFixed(1)}°F` : '--°F';
            document.getElementById('oatValue').textContent = data.oat ? `${data.oat.toFixed(0)}°F` : '--°F';
            document.getElementById('deltaTValue').textContent = data.delta_t ? `${data.delta_t.toFixed(1)}°F` : '--°F';
            document.getElementById('emaDeltaTValue').textContent = data.ema_delta_t ? `${data.ema_delta_t.toFixed(1)}°F` : '--°F';

            // Window status
            const windowItem = document.getElementById('windowStatusItem');
            const windowValue = document.getElementById('windowStatusValue');
            if (data.window_open !== undefined && data.window_open !== null) {
                windowItem.style.display = 'block';
                if (data.window_open) {
                    windowValue.textContent = '🪟 OPEN';
                    windowValue.style.color = 'var(--accent-yellow)';
                } else {
                    windowValue.textContent = '✓ Closed';
                    windowValue.style.color = 'var(--accent-green)';
                }
            } else {
                windowItem.style.display = 'none';
            }

            // Detection status
            const detectionStatus = document.getElementById('detectionStatus');
            if (data.oat_gating_active && !data.detection_enabled) {
                detectionStatus.textContent = 'Detection disabled (OAT too low)';
                detectionStatus.style.color = 'var(--accent-yellow)';
            } else if (data.window_open) {
                detectionStatus.textContent = 'Method C Active | ⚠️ Window Open';
                detectionStatus.style.color = 'var(--accent-yellow)';
            } else {
                detectionStatus.textContent = 'Method C Detection Active';
                detectionStatus.style.color = 'var(--text-muted)';
            }
        }

        async function loadRuntime() {
            const data = await fetchAPI(`/runtime?hours=${state.selectedHours}`);
            if (!data) return;

            document.getElementById('runtimeOn').textContent = data.runtime_on || '--';
            document.getElementById('cycleCount').textContent = data.total_cycles || '0';
            document.getElementById('avgCycleLength').textContent = data.avg_cycle_length || '--';
            document.getElementById('runtimePercent').textContent = data.runtime_percent ? `${data.runtime_percent}%` : '--%';
            document.getElementById('deltaTMean').textContent = data.delta_t_mean ? `${data.delta_t_mean}°F` : '--°F';
            document.getElementById('deltaTMax').textContent = data.delta_t_max ? `${data.delta_t_max}°F` : '--°F';
        }

        async function loadBudgetSummary() {
            const data = await fetchAPI(`/budget?hours=${state.selectedHours}`);
            if (!data) return;

            document.getElementById('estKwh').textContent = data.kwh_estimated ? `${data.kwh_estimated}` : '--';
            document.getElementById('estCost').textContent = data.cost_estimated ? `$${data.cost_estimated.toFixed(2)}` : '$--';
            document.getElementById('runtimeHours').textContent = data.runtime_hours ? `${data.runtime_hours}h` : '--h';
        }

        async function loadBudgetData() {
            const data = await fetchAPI(`/budget?hours=${state.selectedHours}`);
            if (!data) return;

            // Total usage
            document.getElementById('budgetKwh').textContent = data.kwh_estimated ? `${data.kwh_estimated}` : '--';
            document.getElementById('budgetCost').textContent = data.cost_estimated ? `$${data.cost_estimated.toFixed(2)}` : '$--';

            // Peak/Off-peak breakdown
            document.getElementById('peakKwh').textContent = data.peak_kwh ? `${data.peak_kwh}` : '0';
            document.getElementById('peakCost').textContent = data.peak_cost ? `$${data.peak_cost.toFixed(2)}` : '$0.00';
            document.getElementById('offpeakKwh').textContent = data.offpeak_kwh ? `${data.offpeak_kwh}` : '0';
            document.getElementById('offpeakCost').textContent = data.offpeak_cost ? `$${data.offpeak_cost.toFixed(2)}` : '$0.00';
            
            // Format peak hours display
            const formatHour = (h) => h === 0 ? '12 AM' : h < 12 ? `${h} AM` : h === 12 ? '12 PM' : `${h-12} PM`;
            document.getElementById('peakHoursDisplay').textContent = 
                `${formatHour(data.peak_start_hour || 14)} - ${formatHour(data.peak_end_hour || 19)}`;

            // Update toggle state
            const toggle = document.getElementById('peakPricingToggle');
            toggle.classList.toggle('active', data.peak_enabled);

            // Update inputs
            document.getElementById('acKwInput').value = data.ac_kw_setting || 3.5;
            document.getElementById('rateInput').value = data.rate_per_kwh || 0.12;
            document.getElementById('peakRateInput').value = data.peak_rate_per_kwh || 0.25;
            document.getElementById('peakStartInput').value = data.peak_start_hour || 14;
            document.getElementById('peakEndInput').value = data.peak_end_hour || 19;
        }

        async function loadSettings() {
            // Load available sensors first
            const sensorsData = await fetchAPI('/sensors');
            if (sensorsData && sensorsData.sensors) {
                const ratSelect = document.getElementById('ratSensorInput');
                const satSelect = document.getElementById('satSensorInput');
                
                // Clear existing options except first
                ratSelect.innerHTML = '<option value="">-- Select Sensor --</option>';
                satSelect.innerHTML = '<option value="">-- Select Sensor --</option>';
                
                // Add only temperature sensors for RAT/SAT
                sensorsData.sensors.forEach(sensor => {
                    if (sensor.has_temperature) {
                        const optionRat = document.createElement('option');
                        optionRat.value = sensor.name;
                        optionRat.textContent = `${sensor.name} (${sensor.model})`;
                        ratSelect.appendChild(optionRat);
                        
                        const optionSat = document.createElement('option');
                        optionSat.value = sensor.name;
                        optionSat.textContent = `${sensor.name} (${sensor.model})`;
                        satSelect.appendChild(optionSat);
                    }
                });
            }
            
            const data = await fetchAPI('/config');
            if (!data) return;

            state.config = data;

            // Sensor mapping - set selected values
            document.getElementById('ratSensorInput').value = data.rat_sensor || '';
            document.getElementById('satSensorInput').value = data.sat_sensor || '';

            // ΔT Thresholds
            document.getElementById('dtOnInput').value = data.dt_on || 14;
            document.getElementById('dtOffInput').value = data.dt_off || 10;
            document.getElementById('startConfirmInput').value = data.start_confirm_sec || 120;
            document.getElementById('stopConfirmInput').value = data.stop_confirm_sec || 120;
            document.getElementById('minOnInput').value = data.min_on_sec || 180;
            document.getElementById('minOffInput').value = data.min_off_sec || 180;

            // SAT-based detection
            document.getElementById('satDetectionToggle').classList.toggle('active', data.sat_detection_enabled !== false);
            document.getElementById('satLowThresholdInput').value = data.sat_low_threshold || 65;
            document.getElementById('satStableConfirmInput').value = data.sat_stable_confirm_sec || 120;
            document.getElementById('satRiseDeltaInput').value = data.sat_rise_delta || 3;
            document.getElementById('satStabilityToleranceInput').value = data.sat_stability_tolerance || 1;

            // Smoothing
            document.getElementById('smoothingToggle').classList.toggle('active', data.smoothing_enabled !== false);
            document.getElementById('smoothingTauInput').value = data.smoothing_tau || 300;

            // OAT gating
            document.getElementById('oatGatingToggle').classList.toggle('active', data.oat_gating_enabled === true);
            document.getElementById('oatCoolMinInput').value = data.oat_cool_min || 60;

            // Window sensor - populate dropdown with contact sensors
            const windowSensorSelect = document.getElementById('windowSensorInput');
            windowSensorSelect.innerHTML = '<option value="">-- No Sensor --</option>';
            if (sensorsData && sensorsData.sensors) {
                sensorsData.sensors.forEach(sensor => {
                    if (sensor.has_contact) {
                        const option = document.createElement('option');
                        option.value = sensor.name;
                        option.textContent = `${sensor.name} (${sensor.model})`;
                        windowSensorSelect.appendChild(option);
                    }
                });
            }
            windowSensorSelect.value = data.server_window_sensor || '';

            // Budget/pricing
            document.getElementById('tbaseInput').value = data.tbase || 65;
            document.getElementById('peakRateInput').value = data.peak_rate_per_kwh || 0.25;
            document.getElementById('peakStartInput').value = data.peak_start_hour || 14;
            document.getElementById('peakEndInput').value = data.peak_end_hour || 19;
        }

        // ============================================================================
        // Charts
        // ============================================================================
        async function loadChartData() {
            const data = await fetchAPI(`/chart-data?hours=${state.chartHours}`);
            if (!data || !data.timestamps || data.timestamps.length === 0) {
                console.log('No chart data available');
                return;
            }

            renderTempChart(data);
            renderDeltaTChart(data);
            renderStateChart(data);
        }

        function renderTempChart(data) {
            const ctx = document.getElementById('tempChart');
            if (!ctx) return;

            if (tempChart) tempChart.destroy();

            const timestamps = data.timestamps.map(t => new Date(t + 'Z'));

            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        {
                            label: 'RAT (Return)',
                            data: data.rat,
                            borderColor: '#f97316',
                            backgroundColor: 'rgba(249, 115, 22, 0.1)',
                            tension: 0.3,
                            pointRadius: 1
                        },
                        {
                            label: 'SAT (Supply)',
                            data: data.sat,
                            borderColor: '#22d3ee',
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            tension: 0.3,
                            pointRadius: 1
                        }
                    ]
                },
                options: getChartOptions('Temperature (°F)')
            });
        }

        function renderDeltaTChart(data) {
            const ctx = document.getElementById('deltaTChart');
            if (!ctx) return;

            if (deltaTChart) deltaTChart.destroy();

            const timestamps = data.timestamps.map(t => new Date(t + 'Z'));
            const config = state.config;

            deltaTChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        {
                            label: 'ΔT',
                            data: data.delta_t,
                            borderColor: '#a855f7',
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            tension: 0.3,
                            pointRadius: 1
                        },
                        {
                            label: 'EMA ΔT',
                            data: data.ema_delta_t,
                            borderColor: '#ec4899',
                            backgroundColor: 'rgba(236, 72, 153, 0.1)',
                            tension: 0.3,
                            pointRadius: 1
                        }
                    ]
                },
                options: {
                    ...getChartOptions('Delta T (°F)'),
                    plugins: {
                        ...getChartOptions('').plugins,
                        annotation: {
                            annotations: {
                                dtOnLine: {
                                    type: 'line',
                                    yMin: config.dt_on || 14,
                                    yMax: config.dt_on || 14,
                                    borderColor: 'rgba(63, 185, 80, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        display: true,
                                        content: 'ON Threshold',
                                        position: 'start'
                                    }
                                },
                                dtOffLine: {
                                    type: 'line',
                                    yMin: config.dt_off || 10,
                                    yMax: config.dt_off || 10,
                                    borderColor: 'rgba(248, 81, 73, 0.5)',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderStateChart(data) {
            const ctx = document.getElementById('stateChart');
            if (!ctx) return;

            if (stateChart) stateChart.destroy();

            const timestamps = data.timestamps.map(t => new Date(t + 'Z'));
            const stateValues = data.state.map(s => s === 'ON' ? 1 : (s === 'OFF' ? 0 : 0.5));

            stateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'AC State',
                        data: stateValues,
                        borderColor: '#22d3ee',
                        backgroundColor: 'rgba(34, 211, 238, 0.3)',
                        fill: true,
                        stepped: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    ...getChartOptions('State'),
                    scales: {
                        ...getChartOptions('').scales,
                        y: {
                            ...getChartOptions('').scales.y,
                            min: -0.1,
                            max: 1.1,
                            ticks: {
                                callback: v => v === 1 ? 'ON' : (v === 0 ? 'OFF' : ''),
                                color: '#8b949e'
                            }
                        }
                    }
                }
            });
        }

        function getChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { color: '#e6edf3', usePointStyle: true }
                    },
                    title: {
                        display: !!title,
                        text: title,
                        color: '#e6edf3'
                    },
                    tooltip: {
                        backgroundColor: 'rgba(22, 27, 34, 0.95)',
                        titleColor: '#e6edf3',
                        bodyColor: '#e6edf3',
                        borderColor: 'rgba(48, 54, 61, 1)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            displayFormats: {
                                hour: 'MMM d, HH:mm',
                                day: 'MMM d'
                            }
                        },
                        grid: { color: 'rgba(48, 54, 61, 0.5)' },
                        ticks: { color: '#8b949e' }
                    },
                    y: {
                        grid: { color: 'rgba(48, 54, 61, 0.5)' },
                        ticks: { color: '#8b949e' }
                    }
                }
            };
        }

        // ============================================================================
        // Settings & Actions
        // ============================================================================
        async function saveSettings() {
            const config = {
                rat_sensor: document.getElementById('ratSensorInput').value,
                sat_sensor: document.getElementById('satSensorInput').value,
                oat_sensor: null,  // OAT comes from weather API
                dt_on: parseFloat(document.getElementById('dtOnInput').value),
                dt_off: parseFloat(document.getElementById('dtOffInput').value),
                start_confirm_sec: parseInt(document.getElementById('startConfirmInput').value),
                stop_confirm_sec: parseInt(document.getElementById('stopConfirmInput').value),
                min_on_sec: parseInt(document.getElementById('minOnInput').value),
                min_off_sec: parseInt(document.getElementById('minOffInput').value),
                // SAT-based detection
                sat_detection_enabled: document.getElementById('satDetectionToggle').classList.contains('active'),
                sat_low_threshold: parseFloat(document.getElementById('satLowThresholdInput').value),
                sat_stable_confirm_sec: parseInt(document.getElementById('satStableConfirmInput').value),
                sat_rise_delta: parseFloat(document.getElementById('satRiseDeltaInput').value),
                sat_stability_tolerance: parseFloat(document.getElementById('satStabilityToleranceInput').value),
                // Smoothing & gating
                smoothing_enabled: document.getElementById('smoothingToggle').classList.contains('active'),
                smoothing_tau: parseInt(document.getElementById('smoothingTauInput').value),
                oat_gating_enabled: document.getElementById('oatGatingToggle').classList.contains('active'),
                oat_cool_min: parseFloat(document.getElementById('oatCoolMinInput').value),
                tbase: parseFloat(document.getElementById('tbaseInput').value),
                server_window_sensor: document.getElementById('windowSensorInput').value || null
            };

            const result = await fetchAPI('/config', {
                method: 'POST',
                body: JSON.stringify(config)
            });

            if (result && result.success) {
                state.config = result.config;
                showToast('Settings saved successfully', 'success');
            } else {
                showToast('Failed to save settings', 'error');
            }
        }

        async function saveBudgetSettings() {
            const config = {
                ac_kw_running: parseFloat(document.getElementById('acKwInput').value),
                rate_per_kwh: parseFloat(document.getElementById('rateInput').value),
                peak_rate_per_kwh: parseFloat(document.getElementById('peakRateInput').value),
                peak_start_hour: parseInt(document.getElementById('peakStartInput').value),
                peak_end_hour: parseInt(document.getElementById('peakEndInput').value),
                tbase: parseFloat(document.getElementById('tbaseInput').value)
            };

            const result = await fetchAPI('/config', {
                method: 'POST',
                body: JSON.stringify(config)
            });

            if (result && result.success) {
                showToast('Budget settings saved', 'success');
                loadBudgetData();
            } else {
                showToast('Failed to save settings', 'error');
            }
        }

        async function togglePeakPricing() {
            const toggle = document.getElementById('peakPricingToggle');
            const newValue = !toggle.classList.contains('active');
            toggle.classList.toggle('active', newValue);

            await fetchAPI('/config', {
                method: 'POST',
                body: JSON.stringify({ peak_enabled: newValue })
            });

            loadBudgetData();
            showToast(newValue ? 'Peak pricing enabled' : 'Peak pricing disabled', 'success');
        }

        function toggleSetting(setting) {
            const toggle = document.getElementById(setting + 'Toggle');
            toggle.classList.toggle('active');
        }

        async function toggleExcludeWindows() {
            const toggle = document.getElementById('excludeWindowsToggle');
            const newValue = !toggle.classList.contains('active');
            toggle.classList.toggle('active', newValue);

            await fetchAPI('/config', {
                method: 'POST',
                body: JSON.stringify({ exclude_windows_open: newValue })
            });

            loadBudgetData();
        }

        // ============================================================================
        // Time Range Selection
        // ============================================================================
        document.querySelectorAll('.time-selector .time-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const selector = e.target.closest('.time-selector');
                selector.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');

                const hours = parseInt(e.target.dataset.hours);

                if (selector.id === 'chartTimeSelector') {
                    state.chartHours = hours;
                    loadChartData();
                } else {
                    state.selectedHours = hours;
                    loadRuntime();
                    loadBudgetSummary();
                }
            });
        });

        // ============================================================================
        // Server Load Functions
        // ============================================================================
        
        async function loadServerStatus() {
            const data = await fetchAPI('/server-cost/status');
            if (!data) return;
            
            if (!data.has_data) {
                document.getElementById('serverWattsNow').textContent = 'No Data';
                document.getElementById('serverDataAge').textContent = 'Submit readings to begin';
                return;
            }
            
            // Update live values
            document.getElementById('serverWattsNow').textContent = data.server_watts_now ? `${data.server_watts_now}W` : '--';
            document.getElementById('serverBtuNow').textContent = data.heat_btu_hr_now ? `${data.heat_btu_hr_now.toLocaleString()}` : '--';
            document.getElementById('serverHeatKwNow').textContent = data.heat_kw_now ? `${data.heat_kw_now.toFixed(2)}` : '--';
            
            // Update cost rates
            if (data.efficiency_configured && data.cost_rate_per_hr_now !== null) {
                document.getElementById('serverCostRateNow').textContent = `$${data.cost_rate_per_hr_now.toFixed(3)}`;
                document.getElementById('serverCostRateActive').textContent = `$${(data.cost_rate_ac_gated_now || 0).toFixed(3)}`;
                document.getElementById('efficiencyStatus').textContent = `Efficiency configured`;
                document.getElementById('efficiencyStatus').style.color = 'var(--accent-green)';
            } else {
                document.getElementById('serverCostRateNow').textContent = '--';
                document.getElementById('serverCostRateActive').textContent = '--';
                document.getElementById('efficiencyStatus').textContent = '⚠️ Configure efficiency model';
                document.getElementById('efficiencyStatus').style.color = 'var(--accent-yellow)';
            }
            
            // Update AC state indicator (now based on SAT)
            const acRunning = data.ac_is_running;
            const satValue = data.sat_value;
            const windowOpen = data.window_open;
            const acIndicator = document.getElementById('acStateIndicator');
            
            let statusText = '';
            if (satValue !== null) {
                statusText = `SAT: ${satValue}°F`;
                if (acRunning) {
                    statusText += ' (AC ON)';
                }
            } else {
                statusText = 'SAT: --';
            }
            if (windowOpen) {
                statusText += ' | 🪟 Open';
            }
            if (data.is_peak_hour) {
                statusText += ' | Peak';
            }
            
            acIndicator.textContent = statusText;
            acIndicator.style.color = acRunning ? 'var(--accent-cyan)' : 'var(--text-muted)';
            
            // Update data age
            if (data.timestamp) {
                const ts = new Date(data.timestamp + 'Z');
                const age = Math.floor((Date.now() - ts.getTime()) / 1000);
                const ageText = age < 60 ? `${age}s ago` : age < 3600 ? `${Math.floor(age/60)}m ago` : `${Math.floor(age/3600)}h ago`;
                document.getElementById('serverDataAge').textContent = ageText;
            }
        }
        
        async function loadServerSummary() {
            const data = await fetchAPI(`/server-cost/summary?hours=${serverSelectedHours}`);
            if (!data || !data.aggregates) {
                // Reset all values if no data
                ['thermoCostTotal', 'thermoCostClosed', 'thermoCostOpen',
                 'acActiveCostTotal', 'acActiveCostClosed', 'acActiveCostOpen',
                 'serverAvgWatts', 'serverTotalKwh', 'serverSamples'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '--';
                });
                return;
            }
            
            const agg = data.aggregates;
            
            // Thermodynamic costs
            document.getElementById('thermoCostTotal').textContent = `$${agg.thermo_cost_total.toFixed(2)}`;
            document.getElementById('thermoCostClosed').textContent = `$${agg.thermo_cost_windows_closed.toFixed(2)}`;
            document.getElementById('thermoCostOpen').textContent = `$${agg.thermo_cost_windows_open.toFixed(2)}`;
            
            // AC-Active costs
            document.getElementById('acActiveCostTotal').textContent = `$${agg.ac_active_cost_total.toFixed(2)}`;
            document.getElementById('acActiveCostClosed').textContent = `$${agg.ac_active_cost_windows_closed.toFixed(2)}`;
            document.getElementById('acActiveCostOpen').textContent = `$${agg.ac_active_cost_windows_open.toFixed(2)}`;
            
            // Server stats
            document.getElementById('serverAvgWatts').textContent = `${agg.avg_server_watts}W`;
            document.getElementById('serverTotalKwh').textContent = `${agg.total_server_kwh}`;
            document.getElementById('serverSamples').textContent = agg.total_samples;
        }
        
        async function loadServerCharts() {
            const data = await fetchAPI(`/server-cost/chart-data?hours=${serverSelectedHours}`);
            if (!data || !data.timestamps || data.timestamps.length === 0) return;
            
            renderServerWattsChart(data);
            renderServerCostChart(data);
        }
        
        function renderServerWattsChart(data) {
            const ctx = document.getElementById('serverWattsChart');
            if (!ctx) return;
            
            if (serverWattsChart) serverWattsChart.destroy();
            
            const timestamps = data.timestamps.map(t => new Date(t + 'Z'));
            
            serverWattsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [{
                        label: 'Server Watts',
                        data: data.server_watts,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { type: 'time', grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { 
                            beginAtZero: true, 
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            title: { display: true, text: 'Watts' }
                        }
                    }
                }
            });
        }
        
        function renderServerCostChart(data) {
            const ctx = document.getElementById('serverCostChart');
            if (!ctx) return;
            
            if (serverCostChart) serverCostChart.destroy();
            
            const timestamps = data.timestamps.map(t => new Date(t + 'Z'));
            
            // Create AC state band data (0 or max cost for shading when AC is running based on SAT)
            const maxCost = Math.max(...data.cost_rate_per_hr.filter(v => v !== null), 0.01);
            const acStateBand = data.ac_is_running.map((running, i) => running ? maxCost * 1.1 : null);
            
            serverCostChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timestamps,
                    datasets: [
                        {
                            label: 'AC ON',
                            data: acStateBand,
                            borderColor: 'transparent',
                            backgroundColor: 'rgba(34, 211, 238, 0.15)',
                            fill: true,
                            stepped: true,
                            pointRadius: 0
                        },
                        {
                            label: '$/hr (Thermo)',
                            data: data.cost_rate_per_hr,
                            borderColor: '#3fb950',
                            backgroundColor: 'rgba(63, 185, 80, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2
                        },
                        {
                            label: '$/hr (SAT-Gated)',
                            data: data.cost_rate_ac_gated,
                            borderColor: '#22d3ee',
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top', labels: { boxWidth: 12, font: { size: 10 } } } },
                    scales: {
                        x: { type: 'time', grid: { color: 'rgba(255,255,255,0.05)' } },
                        y: { 
                            beginAtZero: true, 
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            title: { display: true, text: '$/hr' }
                        }
                    }
                }
            });
        }
        
        async function submitServerWatts() {
            const input = document.getElementById('manualServerWatts');
            const watts = parseFloat(input.value);
            
            if (isNaN(watts) || watts < 0) {
                showToast('Please enter a valid watts value', 'error');
                return;
            }
            
            const result = await fetchAPI('/server-watts', {
                method: 'POST',
                body: JSON.stringify({ watts, source: 'manual' })
            });
            
            if (result && result.success) {
                showToast(`Server watts (${watts}W) recorded`, 'success');
                input.value = '';
                loadServerStatus();
                loadServerSummary();
                loadServerCharts();
            } else {
                showToast('Failed to submit server watts', 'error');
            }
        }
        
        async function loadServerSettings() {
            // Load available sensors
            const sensorsData = await fetchAPI('/sensors');
            if (sensorsData && sensorsData.sensors) {
                const serverWattsSelect = document.getElementById('serverWattsSensorInput');
                const windowSelect = document.getElementById('serverWindowSensorInput');
                
                // Clear and add options
                serverWattsSelect.innerHTML = '<option value="">-- Not Installed Yet --</option>';
                windowSelect.innerHTML = '<option value="">-- Select Sensor --</option>';
                
                sensorsData.sensors.forEach(sensor => {
                    // Add to server watts (for future power sensors - show all for now)
                    const optWatts = document.createElement('option');
                    optWatts.value = sensor.name;
                    optWatts.textContent = `${sensor.name} (${sensor.model})`;
                    serverWattsSelect.appendChild(optWatts);
                    
                    // Add only contact sensors to window sensor dropdown
                    if (sensor.has_contact) {
                        const optWindow = document.createElement('option');
                        optWindow.value = sensor.name;
                        optWindow.textContent = `${sensor.name} (${sensor.model})`;
                        windowSelect.appendChild(optWindow);
                    }
                });
            }
            
            const config = state.config;
            
            // Efficiency mode
            const modeSelect = document.getElementById('efficiencyModeInput');
            modeSelect.value = config.efficiency_mode || '';
            updateEfficiencyInputVisibility();
            
            // Efficiency values
            document.getElementById('copValueInput').value = config.cop_value || '';
            document.getElementById('eerValueInput').value = config.eer_value || '';
            document.getElementById('kwPerKwHeatInput').value = config.kw_per_kw_heat || '';
            
            // Sensor config
            document.getElementById('serverWattsSensorInput').value = config.server_watts_sensor || '';
            document.getElementById('serverWindowSensorInput').value = config.server_window_sensor || '';
            document.getElementById('satGatingThresholdInput').value = config.server_sat_gating_threshold || 65;
            
            // Gating mode
            document.getElementById('serverGatingModeInput').value = config.server_gating_mode || 'BOTH';
            
            // Exclude windows toggle
            const toggle = document.getElementById('serverExcludeWindowsToggle');
            toggle.classList.toggle('active', config.server_exclude_windows_open === true);
        }
        
        function updateEfficiencyInputVisibility() {
            const mode = document.getElementById('efficiencyModeInput').value;
            document.getElementById('copGroup').style.display = mode === 'COP' ? 'block' : 'none';
            document.getElementById('eerGroup').style.display = mode === 'EER' ? 'block' : 'none';
            document.getElementById('multiplierGroup').style.display = mode === 'MULTIPLIER' ? 'block' : 'none';
        }
        
        // Add listener for efficiency mode change
        document.getElementById('efficiencyModeInput')?.addEventListener('change', updateEfficiencyInputVisibility);
        
        async function saveServerSettings() {
            const mode = document.getElementById('efficiencyModeInput').value;
            
            const config = {
                efficiency_mode: mode || null,
                cop_value: mode === 'COP' ? parseFloat(document.getElementById('copValueInput').value) || null : null,
                eer_value: mode === 'EER' ? parseFloat(document.getElementById('eerValueInput').value) || null : null,
                kw_per_kw_heat: mode === 'MULTIPLIER' ? parseFloat(document.getElementById('kwPerKwHeatInput').value) || null : null,
                server_watts_sensor: document.getElementById('serverWattsSensorInput').value || null,
                server_window_sensor: document.getElementById('serverWindowSensorInput').value || null,
                server_sat_gating_threshold: parseFloat(document.getElementById('satGatingThresholdInput').value) || 65,
                server_gating_mode: document.getElementById('serverGatingModeInput').value || 'BOTH',
                server_exclude_windows_open: document.getElementById('serverExcludeWindowsToggle').classList.contains('active')
            };
            
            // Validate that a value is provided for the selected mode
            if (mode === 'COP' && !config.cop_value) {
                showToast('Please enter a COP value', 'error');
                return;
            }
            if (mode === 'EER' && !config.eer_value) {
                showToast('Please enter an EER value', 'error');
                return;
            }
            if (mode === 'MULTIPLIER' && !config.kw_per_kw_heat) {
                showToast('Please enter a kW/kW multiplier value', 'error');
                return;
            }
            
            const result = await fetchAPI('/config', {
                method: 'POST',
                body: JSON.stringify(config)
            });
            
            if (result && result.success) {
                state.config = result.config;
                showToast('Server efficiency settings saved', 'success');
                loadServerStatus();
                loadServerSummary();
            } else {
                showToast('Failed to save settings', 'error');
            }
        }
        
        function toggleServerExcludeWindows() {
            const toggle = document.getElementById('serverExcludeWindowsToggle');
            toggle.classList.toggle('active');
        }
        
        // Server time selector
        document.getElementById('serverTimeSelector')?.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                document.querySelectorAll('#serverTimeSelector .time-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                serverSelectedHours = parseInt(this.dataset.hours);
                await loadServerSummary();
                await loadServerCharts();
            });
        });

        // ============================================================================
        // Toast Notifications
        // ============================================================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ============================================================================
        // Initialize
        // ============================================================================
        async function init() {
            await loadSettings();
            await refreshData();

            // Auto-refresh status every 3 seconds for live updates (matches Home Hub)
            setInterval(loadStatusQuiet, 3000);
            
            // Refresh budget/charts every 30 seconds (heavier computation)
            setInterval(loadBudgetData, 30000);
        }
        
        // Quiet status refresh - doesn't show loading states, silent on errors
        async function loadStatusQuiet() {
            try {
                await loadStatus();
            } catch (e) {
                // Silent fail for background refresh
            }
        }

        init();
    </script>
</body>
</html>
